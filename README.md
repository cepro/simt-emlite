# Emlite Mediator

## Setup

```
conda create -y -n mediator python=3.11
conda activate mediator

# install dependencies with pip as a number of packages are not in conda-forge
pip install -r requirements.txt
```

## Tests

```
python -m unittest discover
```

## Server

### One mediator from Python

```
EMLITE_HOST=100.79.244.89 EMLITE_PORT=8080 python -m emlite.grpc.emlite-mediator-server
```

### One mediator from Docker

```
docker run --rm -it -p 50051:50051 -e EMLITE_HOST=100.79.244.89 -e EMLITE_PORT=8080 mediator-beta
```

### Multiple mediators defined in docker-compose.yml

```
docker compose up
```

## Client

Pass the port number of the mediator:

```
python -m emlite.grpc.emlite-mediator-client 11002
```

## Messages

Emlite protocol (EMOP) messages are defined using the
[Kaitai](https://kaitai.io) struct language with reference to the Emlite
specifications:

- "SS0001 BM Interface Specification"
- "Base Meter Obis Commands v1.2"

The .ksy files in this folder are used to generate the adjacent python files for
serialising and deserialising the messages. NOTE: if required code can be
generated for a number of other languages including golang, Java and Javascript.

### Code generation

Code is generated by the kaitai-struct-compiler utility.

However at this stage we need to build the compiler to get message serialisation
features which are yet to be released.

Follow the steps at http://doc.kaitai.io/serialization.html except for the
invocation step which appears to be broken. At invocation time do the following
instead:

```sh
cd jvm/target/universal/stage
export CLASSPATH=./lib/io.kaitai.kaitai-struct-compiler-0.11-SNAPSHOT.jar:./lib/org.scala-lang.scala-library-2.12.12.jar:./lib/com.github.scopt.scopt_2.12-3.6.0.jar:./lib/com.lihaoyi.fastparse_2.12-1.0.0.jar:./lib/org.yaml.snakeyaml-1.28.jar:./lib/com.lihaoyi.fastparse-utils_2.12-1.0.0.jar:./lib/com.lihaoyi.sourcecode_2.12-0.1.4.jar
java -cp $CLASSPATH io.kaitai.struct.JavaMain --read-write --target python emlite_frame.ksy
```

## gRPC

We use gRPC to generate a server and client for communication with the mediator.

The gRPC server uses the emlite-api to make calls to the meter.

### Code generation

```
cd emlite/grpc
python grpc_generate.py
```

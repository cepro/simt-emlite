# Emlite Messages

Emlite protocol (EMOP) messages are defined using the
[Kaitai](https://kaitai.io) struct language with reference to the Emlite
specifications:

- "SS0001 BM Interface Specification"
- "Base Meter Obis Commands v1.2"

The .ksy files in this folder are used to generate the adjacent python files for
serialising and deserialising the messages. NOTE: if required code can be
generated for a number of other languages including golang, Java and Javascript.

## Setup

```
conda create -y -n mediator python=3.10
conda activate mediator

# until serialization is merged and released we need to install from the branch like this:
python -m pip install -U --pre git+https://github.com/kaitai-io/kaitai_struct_python_runtime.git@serialization

# following are not in conda repo so installing with pip
pip install crcmod
```

## Tests

```
python -m unittest discover
```

## Server

### One mediator from Python

```
MLITE_HOST=100.79.244.89 -e EMLITE_PORT=8080 python -m emlite.grpc.emlite-mediator-server
```

### One mediator from Docker

```
docker run --rm -it -p 50051:50051 -e EMLITE_HOST=100.79.244.89 -e EMLITE_PORT=8080 mediator-beta
```

### Multiple mediators defined in docker-compose.yml

```
docker compose up
```

## Client

Pass the port number of the mediator:

```
python -m emlite.grpc.emlite-mediator-client 11002
```

## Code generation

Code is generated by the kaitai-struct-compiler utility.

However at this stage we need to build the compiler to get message serialisation
features which are yet to be released.

Follow the steps at http://doc.kaitai.io/serialization.html except for the
invocation step which appears to be broken. At invocation time do the following
instead:

```sh
cd jvm/target/universal/stage
export CLASSPATH=./lib/io.kaitai.kaitai-struct-compiler-0.11-SNAPSHOT.jar:./lib/org.scala-lang.scala-library-2.12.12.jar:./lib/com.github.scopt.scopt_2.12-3.6.0.jar:./lib/com.lihaoyi.fastparse_2.12-1.0.0.jar:./lib/org.yaml.snakeyaml-1.28.jar:./lib/com.lihaoyi.fastparse-utils_2.12-1.0.0.jar:./lib/com.lihaoyi.sourcecode_2.12-0.1.4.jar
java -cp $CLASSPATH io.kaitai.struct.JavaMain --read-write --target python emlite_frame.ksy
```

#!/bin/sh

#
# Compile a kaitai struct file to python
# 
# Usage: kaitai_compile <file.ksy>
#

if [ -z $1 ]
then
    echo "Usage $0 <file.ksy>"
    exit 2
fi

KAITAI_FILE=`pwd`/$1

# Local build of kaitai with serialization (http://doc.kaitai.io/serialization.html).
# NOTE: Once this feature is released we can switch to an installed version.
KAITAI_HOME=`dirname $0`/../../kaitai/kaitai_struct_compiler.serialization
cd $KAITAI_HOME/jvm/target/universal/stage

export CLASSPATH=./lib/io.kaitai.kaitai-struct-compiler-0.11-SNAPSHOT.jar:./lib/org.scala-lang.scala-library-2.12.12.jar:./lib/com.github.scopt.scopt_2.12-3.6.0.jar:./lib/com.lihaoyi.fastparse_2.12-1.0.0.jar:./lib/org.yaml.snakeyaml-1.28.jar:./lib/com.lihaoyi.fastparse-utils_2.12-1.0.0.jar:./lib/com.lihaoyi.sourcecode_2.12-0.1.4.jar
java -cp $CLASSPATH io.kaitai.struct.JavaMain \
    --verbose file \
    --read-write \
    --target python \
    --target graphviz \
    $KAITAI_FILE
echo "Generated files can be found in [$(pwd)]"

# create a png from the graphviz file
echo "\nGenerating png file from graphviz file ..."
BASEFILE=`basename $KAITAI_FILE`
BASEFILE_NO_EXT=${BASEFILE%.*}
dot -Tpng graphviz/$BASEFILE_NO_EXT.dot -o $BASEFILE_NO_EXT.png

